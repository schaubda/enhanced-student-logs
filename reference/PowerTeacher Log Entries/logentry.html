~[if#action.~(gpv.action)=]
<!DOCTYPE html>
<html>
<head>
<title>Submit Log Entry</title>
~[wc:UI_js_includes]
~[wc:UI_submitprogress_cond]
~[wc:commonscripts]
<link href="/images/css/screen.css" rel="stylesheet" media="screen">
<link href="/images/css/print.css" rel="stylesheet" media="print">
<style type="text/css">
    textarea.error, select.error{
        background: none repeat scroll 0 0 rgba(100%, 89%, 71%, 0.5);
        border: 1px solid DarkRed;
        box-shadow: 0 2px 1px rgba(0, 0, 0, 0.2) inset;
    }
</style>
<script type="text/javascript">
<!-- Begin
function formHandler(form){
var URL = document.navigation.page.options[document.navigation.page.selectedIndex].value;
window.location.href = URL;
}
// End -->
</script>

<script type="text/javascript">
var $j = jQuery.noConflict();
	var subject_logkey = "~(JSFieldParam;[08]subject)";
	var entry_logkey  ="~(JSFieldParam;[08]entry)";
	var entrydate_logkey = "~(JSFieldParam;[08]entry_date)";
	var entrytime_logkey = "~(JSFieldParam;[08]entry_time)";

	var helperURL = "/teachers/studentpages/logentry.html";

	$j.fn.serializeObject = function()
	{
		var o = {};
		var a = this.serializeArray();
		$j.each(a, function() {
			if (o[this.name]) {
				if (!o[this.name].push) {
					o[this.name] = [o[this.name]];
				}
				o[this.name].push(this.value || '');
			} else {
				o[this.name] = this.value || '';
			}
		});
		return o;
	};
	$j(function(){
		$j('.datepicker').datepicker();
		$j('#logform select').each(function(i,item){
			var fieldname = $j(item).attr('list');
			$j.get(helperURL, {'action':'getpopup','fieldname':fieldname}, function(popup){
				$j(item).replaceWith(popup);
			});
		})
		panel_shouldShowPanel = false; //variable from ui includes
		$j('#logform').bind('submit', function(event){
			event.preventDefault();
			if(!validateForm(this)){
				panel_shouldShowPanel = false;
				if(loadingDialogInstance){loadingDialogInstance.closeDialog();}
				return false;
			}
			//panel_shouldShowPanel = true;
			var formdata = $j(this).serializeObject();
			$j(this).unbind(event);
			var f = $j(this);
			var emaildata = {
				action:"submit1",
				ac:"submitlogentry",
				logtext:"New log entry created",
				subject:"PowerTeacher log entry",
				studentid:"~(curstudid)"
			};
			if(formdata[entry_logkey] != undefined){emaildata.logtext = formdata[entry_logkey];}
			if(formdata[subject_logkey] != undefined){emaildata.subject = formdata[subject_logkey];}

			try{
				$j.ajax({
					url:helperURL,
					type:"GET",
					beforeSend: function(x){
						if(x && x.overrideMimeType){
							x.overrideMimeType("application/json;charset=UTF-8");
						}
					},
					dataType:"json",
					dataFilter:function(data){
						data = data.replace(/[\r\n\t]/g, '');
						return data;
					},
					data:emaildata,
					async:false,
					success:function(data){
						var blah = data.dcid;
						var udata = {ac:'webasmt'};
						$j.each(formdata, function(key,val){
							var o = {}
							if(key == subject_logkey || key==entry_logkey){return;}//skip changing the subject again
							if(/-1$/.test(key)){
								var newkey = key.replace(/-1$/, data.dcid);
								o[newkey] = val;
							}
							else{ o[key] = val;}
							$j.extend(udata, o);
						});
						var tagsArray = $j.map(udata, function(val, key){ return key;});

						$j.get(helperURL, {action:'formsecurity', tags:tagsArray.join(',')})
						.done(function(tagResponse){
							$j.ajax({
								url:'/teachers/changesrecorded.white.html',
								type:'POST',
								async:false,
								data: udata,
								success: function(){
									window.location = '/teachers/changesrecorded.white.html';
								},
								error:function(){$j.error('Failed to send email notice.  Response Status: '+status);}
							});
						})

					},
					error:function(xhr, status, data){
						$j.error('Failed to save PS audit data.  Response Status: '+status);
					}
				});
			}
			catch(err){
				$j.error(err);//allow normal submission to pass
				return true;
			}
			return false;
		});
	});
	function validateForm(f){
		//make sure form is completely filled out.  Returns false if any data entry is incomplete;otherwise true.
		var retval = true;
		m_invalidRowNumbers =[];
		$j('.validatetext', f).each(function(i, item){
			if($j(item).val() == '' ){
				$j(item).addClass('invalidentry error');
				retval = false;
			}
			else{$j(item).removeClass('invalidentry error');}
		});
		$j('.validatedropdown', f).each(function(i, item){
			if($j(item).val()== ''){
				$j(item).addClass('invalidentry error');
				retval = false;
			}
			else{$j(item).removeClass('invalidentry error');}
		});
		return retval;
	}
	function doPopup(frn){
		$j.get('/teachers/studentpages/logentry.html?action=detailpopup&frn='+frn, function(data){
			var $dialog = $j(data);
			$dialog.dialog({
				autoOpen: true,
				width: 610,
				minWidth: 610,
				height: 450,
				minHeight: 200,
				modal: true,
				resizable: false,
				draggable: false,
				title: 'Log Entry Details'
			});
		});
	}
</script>

~[x:logtypejs]
</head>

<body>

~[wc:teachers_header_fr_css]
 <form name="navigation"><span class="account-photo">~[studenttitlephoto]</span><h1>~[text]psx.html.teachers_studentpages.logentry.submit_log_entry1[/text]<span class="nav-teacher"><select name="page" size=1 onChange="javascript:formHandler()"><option value="">~[text]psx.html.teachers_studentpages.logentry.select_screens[/text]<option value="">--------------------~[x:teacherpages]</select></span>~[studentalert]</h1>
<p>~(studentname) &nbsp; ~(grade_level) &nbsp; ~(student_number) &nbsp; &nbsp; ~(track) &nbsp; &nbsp; ~(studschoolabbr) &nbsp; &nbsp; ~[enrollmentstatus]</p></form>

<!-- Start of shaded content table -->
<div class="box-round">
<form id="logform" method="POST" action="/teachers/changesrecorded.white.html">
<table border="0" cellpadding="2" cellspacing="0" width="100%" background="/images/transparent.gif" class="fourDTable">
~[tlist_sql;
	SELECT
	  NVL(ps_customfields.getcf('gen', g.id, 'FieldLabel'), g.powerlink) AS fieldlabel,
	  lower(value2) AS inputtype,
	  CASE WHEN name = 'logtype' THEN 'logtypeid' ELSE name END AS fieldname, 
	  CASE 
	    WHEN to_char(valuet2) ='00/00/00' AND lower(value2)<>'popup' THEN 'class="datepicker"' 
	    WHEN lower(value2)='popup' THEN 'list="'||g.name||'"'
		ELSE 'class="validatetext"'
	  END as extraAttr
	
	FROM gen g
	WHERE g.cat = 'logentrycodes'
	AND ps_customfields.getcf('gen', g.id, 'EnablePT') = 1
	ORDER BY sortorder, fieldlabel
]
<tr>
<td><label>~(fieldlabel;t)</label></td>
<td>
<~(inputtype;t;if.test=textarea;then=textarea;else.if=popup;then=select;else=input) name="[08]~(name;t)" ~(extraattr;t) ~(inputtype;t;if.test=textarea;then=></textarea>;else.if=popup;then=></select>;else=/>)
</td>
</tr>
[/tlist_sql]
</table>
<div class="button-row">~[submitbutton]</div>
<input type="hidden" name="~(JSFieldParam;[08]Schoolid)" value="~(curschoolid)" />
<input type="hidden" name="~(JSFieldParam;[08]StudentId)" value="~(curstudid)" />
<input type="hidden" name="~(JSFieldParam;[08]TeacherID)" value="~[x:userid]" />
</form>

	<input type="hidden" name="ac" value="webasmt" />
	<input type="hidden" name="ac" value="submitlogentry" />
</div>
<div class="box-round">
<h3>Previous Log Entries</h3>
<table border="1" bordercolor="#dcdcdc" cellpadding="2" cellspacing="0" align="center" width="99%">
<thead>
	<tr bgcolor="#f6f6f6">
	<th>Date</th>
	<th>Logtype</th>
	<th>Subtype</th>
	<th>Subject</th>
	<th>Entry</th>
	<th>Options</th>
</thead>
<tbody>
~[tlist_sql;
SELECT 
	l.entry_date, 
	g1.name as logtypename,
	g2.valuet AS subtypename,
	htf.escape_sc(l.subject),
	htf.escape_sc(l.entry),
	'008'||l.dcid AS logfrn
FROM log l 
JOIN teachers t ON t.id = l.teacherid
JOIN gen g1 ON l.logtypeid = g1.id AND g1.cat = 'logtype'
LEFT JOIN gen g2 ON g2.name = l.logtypeid AND g2.value = l.subtype AND g2.cat = 'subtype'
JOIN  (
SELECT
  substr(txt, instr(txt, CHR(59), 1, level) + 1,  instr(txt, CHR(59), 1, level+1) - instr(txt, CHR(59), 1, level) -1 ) as token
  FROM (SELECT CHR(59)||to_char(valuet2) AS txt FROM gen WHERE cat = 'groups' AND id =(SELECT groupvalue from teachers where id=~[x:userid]))
  CONNECT BY level < length(txt) - length(replace(txt, CHR(59), ''))
) x ON x.token = l.logtypeid
WHERE l.teacherid = ~[x:userid] 
AND l.studentid = ~(curstudid)
ORDER BY l.entry_date DESC
]
<tr bgcolor="#edf3fe">
<td>~(entry_date;d)</td> 
<td>~(ltype;t)&nbsp;</td>
<td>~(logsubtype;t)&nbsp;</td>
<td>~(subject;t)</td> 
<td>~(entry;t)</td>
<td><button onclick='doPopup("~(logfrn;t)")'>View Details</button></td>
</tr>
[/tlist_sql]
</tbody>
</table>
~[wc:teachers_footer_fr_css]
</div>
</body>
</html>
[/if#action]
~[if#action.~(gpv.action)=getpopup]
~[if#specialcheck1.~(gpv.fieldname)=logtype]
<select onchange="setMenu(this)" id="logtype" name="~(JSFieldParam;[08]logtypeid)" onchange="setMenu(this)" class="validatedropdown preview">~(f.html_popup_list;name=lists.logtype)</select>
[else#specialcheck1]
~[if#specialcheck2.~(gpv.fieldname)=subtype]
<select onchange="setSubtype(this)" id="subtype" name="~(JSFieldParam;[08]subtype)" class="preview"></select>
[else#specialcheck2]
<select name="~(JSFieldParam;[08]~(gpv.fieldname))">
	<option value="">&nbsp;</option>
~[tlist_sql;SELECT
      REGEXP_SUBSTR(token,CHR(91)||CHR(94)||','|| CHR(93) ||'+',1,1) as dd_key,
      REGEXP_SUBSTR(token,CHR(91)||CHR(94)||','|| CHR(93) ||'+',1,2) as dd_value,id
      FROM(
        SELECT  regexp_substr(str, '('||CHR(91)||CHR(94)||CHR(91)||CHR(58)||'cntrl'||CHR(58)||CHR(93)||CHR(93)||'+)', 1 , lvl) token, lvl,id
        FROM( 
          SELECT distinct str, level lvl, id 
          FROM (SELECT id, replace(to_char(valuet2),CHR(59), ',') str from gen where cat = 'logentrycodes' and name = '~[gpv:fieldname]')
          CONNECT BY level <= regexp_count(str,'('||CHR(91)||CHR(94)||CHR(91)||CHR(58)||'cntrl'||CHR(58)||CHR(93)||CHR(93)||'+)') + 1
        )
      )
      WHERE token IS NOT NULL
      AND token NOT LIKE ',%'
      ORDER BY dd_value]
	  <option value="~(key;t)">~(label;t)</option>
[/tlist_sql]
[/if#specialcheck2]
[/if#specialcheck1]
</select>
[/if#action]
~[if#action.~(gpv.action)=submit1]
~[tlist_sql;SELECT dcid FROM (SELECT dcid FROM log WHERE teacherid=~[x:userid] AND studentid=~(curstudid)
ORDER BY entry_date DESC, entry_time DESC) WHERE rownum=1]
{
"logfrn":"006~(logdcid;t)",
"dcid":"~(logdcid)"
}
[/tlist_sql]
[/if#action]
~[if#action.~(gpv.action)=detailpopup]
~[f.variable_create;name=tid;type=TEXT;when=NEVER]
~[f.variable_set;name=tid;value=~[x:userid]]
~[if#nohack.~([08]teacherid)#~(v.tid)]
I see what you tried to do, and I'm not happy.(Invalid FRN)
[else#nohack]
<table cellpadding="2" border="1" style="margin:auto;">
<thead>
<tr>
	<th>Label</th>
	<th>Data</th>
</tr>
</thead>
<tbody>
~[f.variable_create;name=logtypeid;type=TEXT;when=NEVER]
~[f.variable_set;name=logtypeid;value=~([08]logtypeid)]
~[f.variable_create;name=subtypevalue;type=TEXT;when=NEVER]
~[f.variable_set;name=subtypevalue;value=~([08]subtype)]
~[tlist_sql;
SELECT name FROM gen g
WHERE g.cat = 'logtype' 
AND g.id = '~(v.logtypeid)'
]<tr class="alt"><td>Log Type</td><td>~(logtypename;t)</td></tr> [/tlist_sql]~[tlist_sql;
SELECT to_char(valuet) FROM gen g
WHERE g.cat = 'subtype' 
AND g.value = '~(v.subtypevalue)'
AND g.name = '~(v.logtypeid)'
]<tr class="alt"><td>Log SubType</td><td>~(subtypename;t)&nbsp;</td></tr>[/tlist_sql]
~[f.variable_create;name=sqlFieldName;type=TEXT;when=NEVER]
~[f.variable_set;name=sqlFieldName;value=
SELECT g.name AS fieldname,
g.powerlink AS fieldlabel,
CASE WHEN 'popup' = lower(to_char(value2)) THEN 1 ELSE 0 END  AS ispopup
FROM gen g
WHERE g.cat = 'logentrycodes'
AND lower(g.name) <>'logtype'
AND lower(g.name) <>'subtype'
AND ps_customfields.getcf('gen', g.id, 'EnablePT') = 1
ORDER BY sortorder,name]
~[f.variable_create;name=sqlPopup;type=TEXT;when=NEVER]
~[f.variable_create;name=sqlHandle2;type=INT;when=NEVER;permanent=0]
~[f.variable_create;name=DSQL2_pdata;type=TEXT;when=NEVER;permanent=0]
~(f.variable_create;name=sqlHandle;type=int;when=NEVER;permanent=0)
~(f.variable_create;name=DSQL1_fieldname;type=TEXT;when=NEVER;permanent=0)
~(f.variable_create;name=DSQL1_fieldlabel;type=TEXT;when=NEVER;permanent=0)
~(f.variable_create;name=DSQL1_ispopup;type=INT;when=NEVER;permanent=0)
~(f.variable_set;name=sqlFieldName;value=[update])
~(f.variable_set;name=sqlHandle;value=~(f.DSQL_New;sql=~(v.sqlFieldName)))
~(f.DSQL_AddSelectColumn;handle=~(v.sqlHandle);col=e:fieldname;col_type=TEXT;var=DSQL1_fieldname)
~(f.DSQL_AddSelectColumn;handle=~(v.sqlHandle);col=e:fieldlabel;col_type=TEXT;var=DSQL1_fieldlabel)
~(f.DSQL_AddSelectColumn;handle=~(v.sqlHandle);col=e:ispopup;col_type=INT;var=DSQL1_ispopup)~(f.DSQL_DoSelect;handle=~(v.sqlHandle))
~(f.DSQL_Browse;handle=~(v.sqlHandle);fn=first_rec)
~[duplicate;~(f.DSQL_Browse;handle=~(v.sqlHandle);fn=count);qq;count;counterstart=1]
~[if#test.~(v.DSQL1_ispopup)#1]
<tr class="alt"><td>~(v.DSQL1_fieldlabel)</td><td>~([08]~[v.DSQL1_fieldname];replace=<,&lt;replace=>,&gt)</td></tr>
[else#test]
~[f.variable_set;name=sqlPopup;value=
SELECT dd_value FROM(
SELECT
      REGEXP_SUBSTR(token,CHR(91)||CHR(94)||','|| CHR(93) ||'+',1,1) as dd_key,
      REGEXP_SUBSTR(token,CHR(91)||CHR(94)||','|| CHR(93) ||'+',1,2) as dd_value,id
      FROM(
        SELECT  regexp_substr(str, '('||CHR(91)||CHR(94)||CHR(91)||CHR(58)||'cntrl'||CHR(58)||CHR(93)||CHR(93)||'+)', 1 , lvl) token, lvl,id
        FROM( 
          SELECT distinct str, level lvl, id 
          FROM (SELECT id, replace(to_char(valuet2),CHR(59), ',') str from gen where cat = 'logentrycodes' and lower(name) = lower('~(v.DSQL1_fieldname)'))
          CONNECT BY level <= regexp_count(str,'('||CHR(91)||CHR(94)||CHR(91)||CHR(58)||'cntrl'||CHR(58)||CHR(93)||CHR(93)||'+)') + 1
        )
      )
      WHERE token IS NOT NULL
) x
WHERE x.dd_key = '~([08]~(v.DSQL1_fieldname))'
]
~[f.variable_set;name=sqlHandle2;value=~(f.DSQL_New;sql=~(v.sqlPopup))]
~(f.DSQL_AddSelectColumn;handle=~(v.sqlHandle2);col=e:pdata;col_type=TEXT;var=DSQL2_pdata)
~(f.DSQL_DoSelect;handle=~(v.sqlHandle2))
~(f.DSQL_Browse;handle=~(v.sqlHandle2);fn=first_rec)
<tr class="alt"><td>~(v.DSQL1_fieldlabel)</td><td>~(v.DSQL2_pdata)</td></tr>
[/if#test]
~(f.DSQL_Browse;handle=~(v.sqlHandle);fn=next_rec)
[/duplicate]
[/if#nohack]
</tbody></table>
[/if#action]
~[if#action.~(gpv.action)=formsecurity]
~[tlist_sql;
	SELECT DISTINCT trim(regexp_substr('~(gpv.tags)', chr(91)||chr(94)||','||chr(93)||'+', 1, LEVEL)) str_2_tab
	FROM dual
	CONNECT BY LEVEL <= regexp_count('~(gpv.tags)', ',')+1
]
<input  name="~(d1)" />
[/tlist_sql]
[/if#action]