<!DOCTYPE html>
<!-- 
	Title:        Submit Log Entry (custom) (logentry.html)
	Created By:   Peter Nethercott
	Date Created: 04/04/2017
	Last Updated: 09/29/2023
	
	Fully custom log entry page. The desired results...
		- Allows further customizations, esp. with Discipline log entries, via page fragment (content.footer.txt).
		- Redirects to Log Entry view page
		- Uses custom code to send email notification(s)
		- Allows Edit of log entries by teacher, IF admin has not modified it. Cannot change Date or Log Type.
		- Tracks historical info about changes to log entry
		- Ability to edit Entry Date is optional based on the log type. For discipline log entries the Incident Date
		  and Time are requested (Entry Date is hidden) and for all other types the Entry Date is shown and editable.

    06/13/2017 - PDN:
        By default, PowerSchool shows the value AND text for Subtypes in the subtype dropdown. This can be confusing.
        Added a function, adjustSubtype(), to reformat the text and is triggered as part of the Log Type onchange event.
        (Thank you to Romy Backus for the suggestion. I found that format bothersome as well.)

    08/09/2017 - PDN:
        Moved where queue (email) fields are being created to ready() vs. [submit].click()

    08/11-14/2017 - PDN:
        Fixed bug where email To address was being populated with "&nbsp;" for New log entries, and was not being sent.
        Added hidden field to hold [schools]tchrlogentrto and it now works better than a direct reference at time of use.

    09/27/2017 - PDN:
        Fixed bug where email was being sent for EVERY log entry to the person designated to receive Discipline log entries.

    08/21/2018 - PDN:
        Fixed bug that was duplicating the "Added by" log history if an error occurred before the save (e.g. "Subtype is required.").

    08/23/2018 - PDN:
        Consolidated added submit click events into a single event.

    07/29/2019 - PDN:
        Added try/catch block to catch instances where school configuration preferences have not been defined.
        + Originally discovered by Cory Hilliard in logview.html +

    04/14/2020 - PDN:
        Fixed issue with Entry Date datepicker being disabled when Log Type is NOT discipline.

    04/24/2020 - PDN:
        Added code to use new default Log Type

    05/05/2020 - PDN:
        Reworked [Submit] event into modular functions.

    05/07/2020 - PDN:
        Fixed bug that was clearing the subtype whenever teacher accessed an existing log.

    11/19/2020 - PDN:
        Cleaned up Subtypes displayed values.
        Ajdusted setupEmail() to allow for a student name to be passed in (for multi-log entry)
    11/23/2020 - PDN:
        Fixed issue of emails not being sent from mulit-logs. Email was being configured after the log was saved.

    05/21/2021 - PDN:
        Fixed bug revealed by PS SIS v21.4 that added new validations for the QUEUE table.

    09/27/2021 - PDN:
        Cleaned up Subtypes displayed values -- removed code that added reverse angle-brackets.
        Modified Entry Date validation to take place only if that date is visible.
        Sometimes necessary for someone in different time zones (e.g. Romy in US but server in Dubai).

    11/05/2021 - PDN:
        Fixed bug that was redirecting teachers back to the previous page if
        "Allow teacher to view his/her own log entries?" was unchecked. This should apply only to the
        logview.html page.

    08/31/2022 - PDN:
        Made the From address pref:systemfromaddress if teacher's email address not set.

    09/29/2023 - PDN: Replaced form element with the new one for v23+ (Thank you to Romy Backus)
-->
<!-- Version 1.1.1 released 05/22/2017 -->
<!-- Version 1.2.0 released 06/02/2017 -->
<!-- Version 1.2.1 released 06/08/2017 -->
<!-- Version 1.3.0 released 06/13/2017 -->
<!-- Version 1.4.0 released 08/14/2017 -->
<!-- Version 1.5.4 released 09/27/2017 -->
<!-- Version 1.6.7 released 07/29/2019 -->
<!-- Version 1.9.5 released 04/24/2020 -->
<!-- Version 2.1.0 released 05/21/2021 -->
<!-- Version 2.2.2 released 09/27/2021 -->
<!-- Version 2.2.3 released 11/05/2021 -->
<!-- Version 2.3.0 released 02/09/2022 -->
<!-- Version <see plugin info> -->
<html>
	<head>
		<title>~[text]psx.html.teachers_studentpages.logentry.submit_log_entry[/text]</title>

		~[wc:UI_js_includes]
		~[wc:commonscripts]
		~[x:logtypejs]

		<link href="/images/css/screen.css" rel="stylesheet" media="screen">
		<link href="/images/css/print.css" rel="stylesheet" media="print">

    	<script src="/scripts/log_management/special_formatting.js"></script>

		<script LANGUAGE="JavaScript">
			//<!-- Begin
			function formHandler(form){
				var URL = document.navigation.page.options[document.navigation.page.selectedIndex].value;
				window.location.href = URL;
			}
			// End -->
		</script>
	</head>

<body class="psteacher">
~[wc:teachers_header_fr_css]

    <form name="navigation">
        ~[wc:teachers_title_student_begin_css]~[text]psx.html.teachers_studentpages.logentry.submit_log_entry1[/text]~[wc:teachers_title_student_end_css]
    </form>
    
<!-- Start of shaded content table -->
<form method="POST" action="logview.html">
    <div class="box-round">
		<table border="0" cellpadding="1" cellspacing="0" width="100%" background="/images/transparent.gif" class="fourDTable">
			<tr>
				<td class="bold"><label for="entryLogDate">~[text:psx.html.teachers_studentpages.logentry.date]</label></td>
				<td><input id="entryLogDate" type="text" class="psDateWidget" value="~[short.date]" size="10" onblur="checkEntryDate($j(this))">
			</tr>
			<tr>
				<td class="bold"><label for="logtype">Log Type</label></td>
				<td><select id="logtype" name="[log]logtypeid" special="lists.logtype" onchange="setMenu(this); adjustSubtype()"><option></select></td>
			</tr>
			<tr>
				<td class="bold" style="width: 19%"><label for="logsubtype">Subtype</label></td>
				<td>~[x:subtype]<input id="logsubtype" type="hidden" name="[log]subtype" value=" "></td>
			</tr>
			<tr>
				<td class="bold"><label for="subject">Title</label></td>
				<td><input id="subject" type="text" name="[log]subject" size="40" value=""></td>
			</tr>
			<tr>
				<td class="bold" valign="top"><label for="entry">~[text:psx.html.teachers_studentpages.logentry.log_entry]</label></td>
				<td><textarea id="entry" name="[log]entry" rows="15" cols="100"></textarea></td>
			</tr>
			<tr>
				<td class="bold" valign="top"><label for="spanLogHistory">Log History</label></td>
				<td>
				    <span id="spanLogHistory" name="[log.U_LogMgmt]change_history" style="display:block"></span>
				    <input type="hidden" id="loghistory" name="[log.U_LogMgmt]change_history" value="">
				</td>
			</tr>
		</table>

        <!-- BUTTON SECTION (HIDDEN FIELDS) -->
		<div class="button-row">
            <!-- Create QUEUE table fields and populate them so that the email information is saved to the table. -->
			<input type="hidden" id="emailType" name="[queue]type" value="100">
			<input type="hidden" id="emailFrom" name="[queue]tdata1" value="">
			<input type="hidden" id="emailTo" name="[queue]tdata2" value="">
			<input type="hidden" id="emailSubject" name="[queue]tdata3" value="">
			<input type="hidden" id="emailBody" name="[queue]tdata4" value="">
			<input type="hidden" id="emailDate" name="[queue]date" value="">
			<input type="hidden" id="emailTime" name="[queue]time" value="">

			<input type="hidden" id="logTeacherID" name="[log]teacherid" value="~[x:userid]">
			<input type="hidden" id="entry_author" name="[log]entry_author" value="~[x:username]">
            <input type="hidden" id="entry_date" name="[log]entry_date" value="~[short.date]">
			<input type="hidden" id="entry_time" name="[log]entry_time" value="~[time]">
			<input type="hidden" id="studentid" name="[log]studentid" value="~([students]id)">

        	<input type="hidden" name="frn" value="~(gpv.frn)">

            <input type="hidden" id="toAddress" name="[schools]tchrlogentrto" value="~([schools]tchrlogentrto)">
            
			<input type="hidden" name="ac" value="webAsmt">
            <a href="logview.html" id="btnBack" name="btnBack" class="button">Back</a>~[submitbutton]

		</div>
        ~[wc:log_fields_script]
		
		<!-- End of shaded content table -->
	</div>
</form>

<script type="text/javascript">

	//var storedprefs=~[tlist_sql;select value from Prefs where name='log_management-S'||'~(curschoolid)';nonemessage=null]~(value)[/tlist_sql];
	//var logRules = (storedprefs === null) ? null : JSON.parse(storedprefs);
	
    var logRules;
    try {
        logRules = JSON.parse(~[prefschool:log_management]);
    }
    catch (e) {
        logRules = null;
    }
	
    // frn=001xxxxx                                     * new *
    // frn=001xxxxx&action=new                          * new *
    // frn=008xxxxxx&studentfrn=001xxxxx&action=edit    * edit *
    var frn = '~(gpv.frn)';
    var studentfrn = (frn.substring(0,3) == '001') ? frn : '~(gpv.studentfrn)';
    var editing = ('~(gpv.action)' == 'edit');

	// Actual Entry Date object to be validated when Submitted
	var inputEntryDate = $j('input#entryLogDate');

	var toggleDatePicker = function() {
        if($j('#entryLogDate').prop('disabled')) {
            $j('#entryLogDate').closest('tr').find('[class*="ui-datepicker"]').hide();
        }
        else {
            $j('#entryLogDate').closest('tr').find('[class*="ui-datepicker"]').removeAttr("disabled").show(); // 04/14/2020 - PDN: Now enables datepicker
        }
	}

    /* ***** PRIMARY FUNCTIONS **************************************************/
    /* Adjust the default text values of the subtype */
    function adjustSubtype() {
        $j('select[name="subtype"] > option').each(function() {
            var subval = $j(this).val();
            var subtext = $j(this).text();
            if(subtext.replace(subval+"  ","").length > 1) {
                //$j(this).text(subtext.replace(subval+" ",""));
                //$j(this).text(subtext.replace(subval,">"+subval+"<"));  // 11/19/2020 - PDN: Changed to this version.
                $j(this).text(subtext.replace(subval,subval+"  "));  // 09/27/2021 - PDN: Changed to this version.
            }

        })
    }
    
	/* Validate entry date when changed (onBlur) */
	function checkEntryDate(eDate) {
		 inputEntryDate = eDate;
		 var entryDate = new Date(inputEntryDate.val());
		 var today = new Date();
		 if(entryDate > today) {
			  inputEntryDate.css("background-color","pink").focus();
			  psAlert({message:'Entry Date cannot be in the future.',title:'WARNING'});
		 } else {
			  inputEntryDate.css("background-color","white");
		 }
	}


    /* 
     * Function: waitForElementToDisplay()
     * looks for a given selector (e.g. '#id', '.class', etc.) and once it's on the page, executes the designated function (pfunc)
     *
     * NOTE: This is much cleaner than simply calling the window.setTimeout() function with a "guess" on how much time will be needed.
     *       The "testing" time increment can be shorter (e.g. 10ms) and the action can then be taken basically as soon as
     *       the element appears on the page, removing the guess work on optimizing the wait time (e.g. 100 <= time <= 500).
     *       In the end we're not as likely to see the actual element (e.g. date picker) on the page, or at least for a shorter amount of time.
     *       At the same time, if more time is needed it will be taken.
    */
    function waitForElementToDisplay(selector, pfunc, time) {
        if(time === undefined) time = 10;   // default to 10ms
        if(document.querySelector(selector) != null) {
            pfunc();
            return;
        }
        else {
            setTimeout(function() {
                waitForElementToDisplay(selector, pfunc, time);
            }, time);
        }
    }
    
    function applyLogRules() {
        // LOG ENTRY MANAGEMENT - APPLY ADMIN CONFIGURATION SETTINGS
        // START CONFIG
        // Change page redirection in case teachers are not allowed to view log entries
        if(logRules === null || !logRules.allowTeacherView) {
            var def_action = ~[tlist_sql;select defaultstudscrn from teachers where id=~[x:userid];nonemessage=null]'~(defaultstudscrn)'[/tlist_sql];
            $j('form[action="logview.html"]').prop('action', def_action);
        }
        // END CONFIG
        
    }

	// *** MAIN STARTUP LOGIC **************************************************

    // Timeout must be done so that class="psDateWidget" has enough time to be applied before determining if it needs to be hidden.
    waitForElementToDisplay('img.ui-datepicker-trigger', toggleDatePicker, 10);

	$j( function() {

        applyLogRules();

	    inputEntryDate.val($j('#entry_date').val());
	    
        // Set "page" dropdown to currently selected page
        $j('select[name="page"] option').filter(function() {
			return this.text == $j('title').text();
		}).attr('selected', true);

        // Check if started from listview.html ("action" will have a value if it was)
        if('~(gpv.action)' == '') {
            $j('#btnBack').hide();
        }
        else {
    	    // Set href on [Back] button
        	$j('#btnBack').attr("href", $j('#btnBack').attr("href")+'?frn='+studentfrn );
        }
    	
        // Set log/subtype selectors to selected log entry's values or default Log Type and initiate (.change) populating Subtype options based on logtypeid parameter (default '-100000')
        $j('select#logtype').val( function() {
            return (editing) ? ~([log]logtypeid) : ('~(gpv.logtypeid)' == '') ? (('~[displayprefuser:logmgmt_deflogtype]' == '') ? -100000 : '~[displayprefuser:logmgmt_deflogtype]') : '~(gpv.logtypeid)';
        }); // .change() event must be set before this line of code, otherwise, have to manually hide the subtype row.
        setTimeout(function () {
            $j('select#logtype').change();
            $j('select[name="subtype"]').val( $j('#logsubtype').val() );
        },100); // allow a moment for log type to get set before initiating the change event

        // This would be how to disable [Submit], in case we wanted to add logic to do so until something has changed.
        // NOTE: Perhaps use the PSField array, with Date plus Log Type added for NEW, and add blur / changed event to each
    	//$j('button[type="submit"]').prop('disabled', true);
	
        if(editing) {  // edit
            $j('#entryLogDate').prop('disabled', true);
            $j('select#logtype').prop('disabled', true);
        }
        else if ($j('select#logtype').val() == '-100000') {
            $j('#entryLogDate').prop('disabled', true);
        }
        else {
            $j('#entryLogDate').prop('disabled', false);
            $j('select#logtype').prop('disabled', false);
        }
        
		$j('#spanLogHistory').html($j('#loghistory').val());    // show log modification history
		
	});

    // ***** ASSIGN ADDITIONAL EVENTS **************************************************
    function validateInput() {
        if(jQuery('#entryLogDate').is(":visible")) {
            var entryDate = new Date(inputEntryDate.val());
            var today = new Date();
            if(entryDate > today) {
                psAlert({message:'Entry Date cannot be in the future.',title:'WARNING'});
                inputEntryDate.css("background-color","pink").focus();
                return false;
            }
        }
        return true;
    }

    function setupEmail(stuname) {
        if(!(!!stuname)) {
            stuname = "~([students]lastfirst)";
        }
		var toaddr = $j('#toAddress').val();
	    if($j('select#logtype').val() != '-100000') {
            // Should an email be sent for this log type? Check log rules in preferences.
			toaddr = "";
            var emaillist = logRules.logemail;
            $j.each(emaillist, function( index, logemail ) {
                if($j('select#logtype').val() == logemail.logtype) {
                    toaddr = logemail.address
                }
            });
		}

	    // Email To addresses are now configurable via prefs to allow emailing for other Log Types
	    if(toaddr != "") {
	        
			// toaddr is now populated above and used to determine if email should be sent
			var fromaddr = ~[tlist_sql;select users.email_addr from users, schoolstaff where users.dcid = schoolstaff.users_dcid and schoolstaff.id = ~[x:userid];nonemessage=null]"~(email_addr)"[/tlist_sql];
            fromaddr = fromaddr || "~[displaypref:systemfromaddr]"; // 08/31/2022 - PDN : Use the System From Address if the teacher's email has not been set.
            
			var subject = (!!editing) ? "Modified" : "New";
			subject += " Log entry: "+stuname;
			var body = "Title: "+$j('#subject').val()+"\r\n";
			body += "Teacher: ~[x:username]\r\n\r\n";
			body += $j('#entry').val();
/* * /
			console.log("From: "+fromaddr+"\nTo: "+toaddr+"\nEmail Subject: "+subject+"\n"+body);
/* */
			$j('#emailType').val(100);  // According to PowerSchool 10.x Data Dictionary Tables: 100=email, 700=old portal count, 1200=Parsed XML2 documents that need to be deleted, 1300=Auto SAIS
			$j('#emailFrom').val(fromaddr);
			$j('#emailTo').val(toaddr);
			$j('#emailSubject').val(subject);
			$j('#emailBody').val(body);
			$j('#emailDate').val("~[short.date]");
			$j('#emailTime').val("~[time]");
/* */
	    }
    }
    
    function buildHistory() {
		/* Format Log History like Stored Grades. For example:
		 *      [10/27/16-09:43:10 AM-uXXXXX-sYYYYY]Created by store grades
		 *      [4/18/17-03:23:03 PM-uXXXXX-sYYYYY]Modified; Grade old= new=I
		 */
        var today = new Date();
        var date = formatDateMMDDYYYY(today);
        var time = formatTimeAMPM(today);
        var dateTime = date+'-'+time;
        
    	var whatChanged = (editing) ? checkWhatHasChanged() : "";
		var newHistory = (editing) ? $j('#loghistory').val() : "";
		if(!editing || whatChanged.length > 1) {
    		newHistory += "["+dateTime+"-u~[x:userid]-s~(curschoolid)]";
    		newHistory += (editing ? "Updated" : "Added") + " by teacher"+whatChanged+"<BR>";
		}
		
		$j('#loghistory').val(newHistory);
    }

	// Add event to be processed when the form is submitted (saved)
	//$j("#entryLogDate").closest("form").submit(function() {
    $j('button[type="submit"]').click(function() {
        
        if(!validateInput()) return false;

        $j('#entry_date').val(inputEntryDate.val());

        buildHistory();
        
        setupEmail("~([students]lastfirst)");
	});

	// Add event to [Submit] button to validate entry date when page is submitted
	/*
	$j('button[type="submit"]').click(function() {
		 var entryDate = new Date(inputEntryDate.val());
		 var today = new Date();
		 if(entryDate > today) {
			  psAlert({message:'Entry Date cannot be in the future.',title:'WARNING'});
			  inputEntryDate.css("background-color","pink").focus();
			  return false;
		 }
	});
    */
    
	// Add onChange event handler to Log Type selector
	$j('select#logtype').change( function() {
        if ($j('select#logtype').val() == '-100000') {
            $j('#entryLogDate').prop('disabled', true);
            if(!editing) $j('#entryLogDate').val('~[short.date]');
            toggleDatePicker();
        }
        else {
            $j('#entryLogDate').prop('disabled', false);
            toggleDatePicker();
        }
	});
 
</script>

~[wc:teachers_footer_fr_css]
		

</body>
</html>
